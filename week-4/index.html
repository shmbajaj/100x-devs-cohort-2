<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>React DOM Practice Assignment</title>
    <style>
      .none {
        display: none;
      }
    </style>
  </head>

  <body>
    <form id="add-todo">
      <input type="text" name="title" placeholder="Todo title" required />
      <input
        type="text"
        name="description"
        placeholder="Todo description"
        required
      />
      <button type="submit">Add todo</button>
    </form>

    <ul id="todos"></ul>
    <script>
      let globalId = 1;
      let todoState = [];
      let oldTodoState = [];

      const todos = document.getElementById('todos');

      function deleteHandler(e) {
        const parent = e.target.parentElement;
        const id = +parent.getAttribute('data-todoid');
        const index = todoState.findIndex((t) => t.id === id);
        todoState.splice(index, 1);
        updateState(todoState);
      }

      function saveHandler(e) {
        e.preventDefault();
        const editForm = e.target;
        const parent = editForm.parentElement;
        const formData = new FormData(editForm);
        const title = formData.get('title');
        const description = formData.get('description');
        const id = +parent.getAttribute('data-todoid');
        // const id = formData.get('id');
        const updatedTodo = { id, title, description };
        const index = todoState.findIndex((t) => t.id === updatedTodo.id);
        todoState[index] = updatedTodo;
        updateState(todoState);
        editForm.nextSibling.classList.remove('none');
        editForm.classList.add('none');
      }

      function editHandler(e) {
        const node = e.target;
        const todoContentContainer = node.previousElementSibling;
        const editForm = todoContentContainer.previousElementSibling;
        todoContentContainer.classList.add('none');
        editForm.classList.remove('none');
      }

      //TODO: refactor the following function
      function updateTodoInDom(oldTodo, newTodo) {
        if (Object.is(oldTodo, newTodo)) {
          return;
        }
        const areTitleSame = oldTodo.title === newTodo.title;
        const areDescriptionSame = oldTodo.description === newTodo.description;
        if (areTitleSame && areDescriptionSame) {
          return;
        }
        const todo = document.querySelector(`[data-todoid="${oldTodo.id}"]`);
        if (!areTitleSame) {
          todo.children[2].children[0].textContent = newTodo.title;
        }
        if (!areDescriptionSame) {
          todo.children[2].children[1].textContent = newTodo.description;
        }
      }

      function removeTodoFromDom(todo) {
        document.querySelector(`[data-todoid="${todo.id}"]`).remove();
      }

      function addTodoToDom(todo) {
        const todoContainer = document.createElement('li');
        const todoContentContainer = document.createElement('div');
        const todoId = document.createElement('span');
        const todoTitle = document.createElement('div');
        const todoDescription = document.createElement('p');
        const editForm = document.createElement('form');
        const idInput = document.createElement('input');
        const titleInput = document.createElement('input');
        const descriptionInput = document.createElement('input');
        const deleteTodo = document.createElement('button');
        const editTodo = document.createElement('button');
        const saveTodo = document.createElement('button');

        todoId.classList.add('none');
        todoId.textContent = todo.id;
        todoDescription.textContent = todo.description;
        todoTitle.textContent = todo.title;

        idInput.setAttribute('name', 'id');
        idInput.setAttribute('type', 'hidden');
        idInput.value = todo.id;
        titleInput.setAttribute('name', 'title');
        titleInput.setAttribute('type', 'text');
        titleInput.setAttribute('required', true);
        titleInput.value = todo.title;
        descriptionInput.setAttribute('name', 'description');
        descriptionInput.setAttribute('type', 'text');
        descriptionInput.setAttribute('required', true);
        descriptionInput.value = todo.description;
        saveTodo.textContent = 'Save';

        editForm.classList.toggle('none');
        editForm.appendChild(titleInput);
        editForm.appendChild(descriptionInput);
        editForm.appendChild(saveTodo);
        editForm.addEventListener('submit', saveHandler);

        deleteTodo.textContent = 'Delete';
        deleteTodo.addEventListener('click', deleteHandler);

        editTodo.textContent = 'Edit';
        editTodo.addEventListener('click', editHandler);

        todoContentContainer.setAttribute('data-todoid', todo.id);
        todoContentContainer.appendChild(todoTitle);
        todoContentContainer.appendChild(todoDescription);

        todoContainer.appendChild(todoId);
        todoContainer.appendChild(editForm);
        todoContainer.appendChild(todoContentContainer);
        todoContainer.appendChild(editTodo);
        todoContainer.appendChild(deleteTodo);

        todoContainer.setAttribute('data-todoid', todo.id);

        todos.prepend(todoContainer);
      }

      function updateState(newTodos) {
        // calculate the diff b/w newTodos and oldTodos.
        // More specifically, find out what todos are -
        // 1. added
        // 2. deleted
        // 3. updated
        const newTodosIds = newTodos.map((t) => t.id);
        const oldTodosIds = oldTodoState.map((t) => t.id);
        const added = newTodos.filter((e) => !oldTodosIds.includes(e.id));
        const deleted = oldTodoState.filter((e) => !newTodosIds.includes(e.id));
        //TODO: update following function from O(n^2)
        const updated = newTodos
          .filter((e) => oldTodosIds.includes(e.id))
          .map((newTodo) => {
            const oldTodo = oldTodoState.find((o) => newTodo.id === o.id);
            return [oldTodo, newTodo];
          });
        // calculate these 3 arrays
        // call addTodo, removeTodo, updateTodo functions on each of the
        // elements
        added.forEach((t) => addTodoToDom(t));
        deleted.forEach((t) => removeTodoFromDom(t));
        updated.forEach((t) => updateTodoInDom(...t));
        oldTodoState = newTodos.slice();
      }

      function addTodo({ title, description }) {
        todoState.push({
          title: title,
          description: description,
          id: globalId++,
        });
        updateState(todoState);
      }
    </script>
    <script>
      const form = document.getElementById('add-todo');
      const getData = () => {
        const formData = new FormData(form);
        const title = formData.get('title');
        const description = formData.get('description');
        form.reset();
        addTodo({ title, description });
      };
      const onSubmit = (e) => {
        e.preventDefault();
        getData();
      };
      form.addEventListener('submit', onSubmit);
    </script>
  </body>
</html>
